import type { QuizAttempt, QuizBundle, LearningProfile } from './types';
import { USE_MOCKS, API_BASE_URL, authHeaders, store, delay, MOCK_LEARNING_PROFILE } from './api-core';

export async function getQuizAttempts(studentId: string, filters?: { keyword_id?: string; quiz_type?: string }): Promise<QuizAttempt[]> { if (USE_MOCKS) { await delay(); let r = store.quizAttempts.filter(a => a.student_id === studentId); if (filters?.keyword_id) r = r.filter(a => a.keyword_id === filters.keyword_id); if (filters?.quiz_type) r = r.filter(a => a.quiz_type === filters.quiz_type); return r; } const p = new URLSearchParams({ student_id: studentId }); if (filters?.keyword_id) p.set('keyword_id', filters.keyword_id); if (filters?.quiz_type) p.set('quiz_type', filters.quiz_type); return (await (await fetch(`${API_BASE_URL}/quiz-attempts?${p}`, { headers: authHeaders() })).json()).data; }
export async function completeQuizSession(studentId: string, sessionId: string, attemptIds: string[]): Promise<QuizBundle> { if (USE_MOCKS) { await delay(); const atts = store.quizAttempts.filter(a => attemptIds.includes(a.id)); const ts = atts.reduce((s, a) => s + a.score, 0); const tq = atts.reduce((s, a) => s + a.total_questions, 0); return { session_id: sessionId, attempts: atts, summary: { total_score: ts, total_questions: tq, average_score: tq > 0 ? ts / atts.length : 0 } }; } return (await (await fetch(`${API_BASE_URL}/quiz-sessions/complete`, { method: 'POST', headers: authHeaders(), body: JSON.stringify({ student_id: studentId, session_id: sessionId, attempt_ids: attemptIds }) })).json()).data; }
export async function getLearningProfile(studentId: string): Promise<LearningProfile | null> { if (USE_MOCKS) { await delay(); if (studentId === MOCK_LEARNING_PROFILE.student_id) return { ...MOCK_LEARNING_PROFILE }; return null; } return (await (await fetch(`${API_BASE_URL}/students/${studentId}/learning-profile`, { headers: authHeaders() })).json()).data; }
